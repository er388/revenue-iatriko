# ğŸ”„ Î‘Î»Î»Î±Î³Î­Ï‚ Î£Ï…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ ÎšÏÎ±Ï„Î®ÏƒÎµÏ‰Î½

## ğŸ“‹ Î¤Î¹ Î†Î»Î»Î±Î¾Îµ

### ÎÎ­Î± Î”Î¿Î¼Î® ÎšÏÎ±Ï„Î®ÏƒÎµÏ‰Î½

#### **Î•ÎŸÎ Î¥Î¥ (5 Ï€ÎµÎ´Î¯Î±)**:
1. **Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·** (â‚¬) - Î•Î¹ÏƒÏ€ÏÎ¬Ï‡Î¸Î·ÎºÎµ Î±Ï€ÏŒ ÎµÎ¾ÎµÏ„Î±Î¶ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚
2. **ÎœÎ”Î•** (â‚¬) - ÎœÎ·Ï‡Î±Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ®Ï‚ Î•Ï€Î¯Î»Ï…ÏƒÎ·Ï‚  
3. **Rebate** (â‚¬) - ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·
4. **ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚** (â‚¬) - Î”Î¹Î¬Ï†Î¿ÏÎµÏ‚ ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚
5. **Clawback** (â‚¬) - Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î®

**ÎŒÎ»Î± Î±Ï†Î±Î¹ÏÎ¿ÏÎ½Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ Ï€Î¿ÏƒÏŒ:**
```
Î¤ÎµÎ»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ = Î‘ÏÏ‡Î¹ÎºÏŒ - (Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ· + ÎœÎ”Î• + Rebate + ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚ + Clawback)
```

#### **Î†Î»Î»Î± Î¤Î±Î¼ÎµÎ¯Î± (1 Ï€ÎµÎ´Î¯Î¿)**:
- **ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚** (â‚¬) - Î“ÎµÎ½Î¹ÎºÎ­Ï‚ ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚

```
Î¤ÎµÎ»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ = Î‘ÏÏ‡Î¹ÎºÏŒ - ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚
```

---

## ğŸ“Š ÎÎ­Î± Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Dashboard

### Main KPIs:
- âœ… Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÏƒÎ¿Î´Î±
- âœ… Î•ÎŸÎ Î¥Î¥ (Î¤ÎµÎ»Î¹ÎºÏŒ)
- âœ… Î†Î»Î»Î± Î¤Î±Î¼ÎµÎ¯Î±
- âœ… ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚ (ÎŒÎ»ÎµÏ‚)

### Î•ÎŸÎ Î¥Î¥ Breakdown (5 KPI Cards):
- ğŸŸ¡ Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·
- ğŸŸ£ ÎœÎ”Î•
- ğŸ”´ Rebate
- ğŸ”µ ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚
- ğŸ”´ Clawback

### Toggle:
- **"ÎœÎµ Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·"**: Î•Î¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ ÏƒÏÎ½Î¿Î»Î¿ **ÎœÎ•** Ï„Î·Î½ Ï€Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ· (ÎµÏ€ÎµÎ¹Î´Î® ÎµÎ¹ÏƒÏ€ÏÎ¬Ï‡Î¸Î·ÎºÎµ)
- **Î§Ï‰ÏÎ¯Ï‚ checkbox**: Î•Î¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ ÏƒÏÎ½Î¿Î»Î¿ **Î§Î©Î¡Î™Î£** Ï€Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·

---

## ğŸ“ Î‘ÏÏ‡ÎµÎ¯Î± Ï€Î¿Ï… Î†Î»Î»Î±Î¾Î±Î½

### 1. **eopyyClawback.js** â†’ **eopyyClawback.js (v2)**
- ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±: `EopyyDeductionsManager`
- ÎÎ­Î± structure: 5 deductions Î³Î¹Î± Î•ÎŸÎ Î¥Î¥
- ÎÎ­ÎµÏ‚ Î¼Î­Î¸Î¿Î´Î¿Î¹: `getAmountsBreakdown()`, `calculateKPIs()`
- Options: `{includeParakratisi: bool}`

### 2. **index.html (v2)**
- ÎÎ­Î± forms: `quickEopyyDeductions` (5 fields)
- ÎÎ­Î± forms: `modalEopyyDeductions` (5 fields)
- ÎÎ­Î± forms: `quickNonEopyyDeductions` (1 field)
- ÎÎ­Î± forms: `modalNonEopyyDeductions` (1 field)
- 5 KPI cards Î³Î¹Î± Î•ÎŸÎ Î¥Î¥ breakdown
- Toggle: "ÎœÎµ Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·"

### 3. **app.js (v2)**
- Import: `eopyyDeductionsManager` (updated)
- Entry structure: `entry.deductions = {parakratisi, mde, rebate, krathseis, clawback}`
- KPI calculation: `calculateKPIs(entries, {includeParakratisi})`
- Form handlers: `showDeductionFields()`, `showModalDeductionFields()`
- CSV export: Includes all 5 deductions

### 4. **pdfExport.js (v2)**
- Updated: `exportDashboard()` - includes breakdown
- Updated: `exportEntriesList()` - shows deductions
- Uses: `eopyyDeductionsManager.getAmountsBreakdown()`

### 5. **storage.js** - ÎŸÎš (no changes)
- Saves: `eopyyDeductions` setting

---

## ğŸ§ª Testing Checklist

### Î•ÎŸÎ Î¥Î¥ Entries
```
âœ… Create Î•ÎŸÎ Î¥Î¥ entry
âœ… Add Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·: 50â‚¬
âœ… Add ÎœÎ”Î•: 30â‚¬
âœ… Add Rebate: 20â‚¬
âœ… Add ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚: 40â‚¬
âœ… Add Clawback: 60â‚¬
âœ… Verify: Î¤ÎµÎ»Î¹ÎºÏŒ = Î‘ÏÏ‡Î¹ÎºÏŒ - 200â‚¬
âœ… Dashboard shows all 5 breakdowns
âœ… Toggle "ÎœÎµ Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·" changes KPI
```

### Non-Î•ÎŸÎ Î¥Î¥ Entries
```
âœ… Create Î™Î´Î¹Ï‰Ï„Î¹ÎºÎ® entry
âœ… Add ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚: 100â‚¬
âœ… Verify: Î¤ÎµÎ»Î¹ÎºÏŒ = Î‘ÏÏ‡Î¹ÎºÏŒ - 100â‚¬
âœ… Only 1 field visible
```

### CSV Export
```
âœ… Export includes: Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·, ÎœÎ”Î•, Rebate, ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚, Clawback
âœ… Non-Î•ÎŸÎ Î¥Î¥: Zeros for Î•ÎŸÎ Î¥Î¥ fields
```

### PDF Export
```
âœ… Dashboard PDF shows breakdown
âœ… Entries PDF shows deductions
```

---

## ğŸ“¦ Deployment

### Î‘ÏÏ‡ÎµÎ¯Î± Ï€Î¿Ï… Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÎ¹Ï‚:

1. âœ… **eopyyClawback.js** (ÎÎ•ÎŸ - v2)
2. âœ… **index.html** (ÎÎ•ÎŸ - v2)
3. âœ… **app.js** (ÎÎ•ÎŸ - v2)
4. âœ… **pdfExport.js** (ÎÎ•ÎŸ - v2)

### Î‘ÏÏ‡ÎµÎ¯Î± Ï€Î¿Ï… Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Ï‰Ï‚ Î­Ï‡Î¿Ï…Î½:
- styles.css
- utils.js
- storage.js
- backup.js
- comparison.js
- forecasting.js
- charts.js
- cloudAdapters.js
- csvValidator.js
- cdnChecker.js
- service-worker.js
- oauth-callback.html

---

## ğŸ’¡ Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Î§ÏÎ®ÏƒÎ·Ï‚

### Scenario 1: Î•ÎŸÎ Î¥Î¥ Invoice
```javascript
Entry:
- Î‘ÏÏ‡Î¹ÎºÏŒ: 1000â‚¬
- Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·: 100â‚¬ (10%)
- ÎœÎ”Î•: 50â‚¬ (5%)
- Rebate: 30â‚¬ (3%)
- ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚: 40â‚¬ (4%)
- Clawback: 80â‚¬ (8%)

Calculations:
- Î£ÏÎ½Î¿Î»Î¿ ÎšÏÎ±Ï„Î®ÏƒÎµÏ‰Î½: 300â‚¬
- Î¤ÎµÎ»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ: 700â‚¬
- Î¤ÎµÎ»Î¹ÎºÏŒ (Ï‡Ï‰ÏÎ¯Ï‚ Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·): 800â‚¬
```

### Scenario 2: Î™Î´Î¹Ï‰Ï„Î¹ÎºÎ® Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±
```javascript
Entry:
- Î‘ÏÏ‡Î¹ÎºÏŒ: 500â‚¬
- ÎšÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚: 50â‚¬ (10%)

Calculations:
- Î£ÏÎ½Î¿Î»Î¿ ÎšÏÎ±Ï„Î®ÏƒÎµÏ‰Î½: 50â‚¬
- Î¤ÎµÎ»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ: 450â‚¬
```

---

## ğŸ¯ API Changes

### Old (v1):
```javascript
clawbackManager.applyClawback(entryId, clawbackAmount, clawbackPercent, notes)
```

### New (v2):
```javascript
deductionsManager.applyDeductions(entryId, {
    parakratisi: 100,
    mde: 50,
    rebate: 30,
    krathseis: 40,
    clawback: 80
}, notes)
```

### Get Breakdown:
```javascript
const amounts = deductionsManager.getAmountsBreakdown(entry);
// Returns:
{
    originalAmount: 1000,
    parakratisi: 100,
    mde: 50,
    rebate: 30,
    krathseis: 40,
    clawback: 80,
    totalDeductions: 300,
    finalAmount: 700,
    finalAmountNoParakratisi: 800,
    hasDeductions: true
}
```

### Calculate KPIs:
```javascript
// Without Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·
const kpis = deductionsManager.calculateKPIs(entries, {includeParakratisi: false});

// With Î Î±ÏÎ±ÎºÏÎ¬Ï„Î·ÏƒÎ·
const kpis = deductionsManager.calculateKPIs(entries, {includeParakratisi: true});
```

---

## âœ¨ Î¤ÎµÎ»Î¹ÎºÎ­Ï‚ Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚

**Backward Compatibility**: âŒ NO
- Î Î±Î»Î¹Î¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¼ÎµÏ„Î±Ï†ÎµÏÎ¸Î¿ÏÎ½ manually
- Backup Ï€ÏÎ¹Î½ Ï„Î¿ update!

**Migration Path**:
1. Export backup (old version)
2. Update files
3. Import backup
4. Add deductions manually Î³Î¹Î± Ï…Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎµÏ‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚

---

**Version:** 2.0 (Advanced Deductions)  
**Last Updated:** 2025-01-12  
**Status:** âœ… Ready for Deployment