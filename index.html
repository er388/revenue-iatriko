<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Εσόδων</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>Διαχείριση Εσόδων</h1>
            <div class="header-actions">
                <span id="userLabel" class="user-label">Χρήστης: Admin</span>
                <span id="autosaveIndicator" class="autosave-indicator" style="display: none;">Αποθηκεύτηκε</span>
                <button id="backupBtn" class="btn-secondary btn-compact">💾 Backup</button>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="container">
            <button class="nav-tab active" data-view="dashboard">📊 Dashboard</button>
            <button class="nav-tab" data-view="entries">📋 Εγγραφές</button>
            <button class="nav-tab" data-view="reports">📈 Αναφορές</button>
            <button class="nav-tab" data-view="comparison">🔄 Σύγκριση</button>
            <button class="nav-tab" data-view="forecasting">🔮 Προβλέψεις</button>
            <button class="nav-tab" data-view="heatmaps">🌡️ Heatmaps</button>
            <button class="nav-tab" data-view="cloud">☁️ Cloud</button>
            <button class="nav-tab" data-view="settings">⚙️ Ρυθμίσεις</button>
        </div>
    </nav>

    <main class="container main-content">
        
        <!-- Dashboard View -->
        <div id="dashboardView" class="view active">
            <h2>Επισκόπηση</h2>

            <!-- Quick Add Form (Draggable Block #1) -->
            <div class="draggable-block" data-block="quickAdd">
                <div class="card card-compact">
                    <div class="block-drag-handle">⋮⋮</div>
                    <h3>Γρήγορη Καταχώριση</h3>
                    <form id="quickAddForm">
                        <div class="form-row">
                            <div class="form-group form-group-compact">
                                <label>Ημερομηνία (ΜΜ/ΕΕΕΕ)*</label>
                                <input type="text" id="quickDate" class="form-input form-input-compact" placeholder="01/2025" required>
                            </div>
                            <div class="form-group form-group-compact">
                                <label>Διαγνωστικό*</label>
                                <select id="quickSource" class="form-select form-select-compact" required>
                                    <option value="">Επιλογή...</option>
                                </select>
                            </div>
                            <div class="form-group form-group-compact">
                                <label>Ασφάλεια*</label>
                                <select id="quickInsurance" class="form-select form-select-compact" required>
                                    <option value="">Επιλογή...</option>
                                </select>
                            </div>
                            <div class="form-group form-group-compact">
                                <label>Τύπος*</label>
                                <select id="quickType" class="form-select form-select-compact" required>
                                    <option value="cash">Μετρητά</option>
                                    <option value="invoice">Τιμολόγια</option>
                                </select>
                            </div>
                            <div class="form-group form-group-compact">
                                <label>Ποσό (€)*</label>
                                <input type="number" id="quickAmount" class="form-input form-input-compact" step="0.01" min="0" required>
                            </div>
                        </div>
                        
                        <!-- ΕΟΠΥΥ Deductions -->
                        <div id="quickEopyyDeductions" class="retention-fields retention-compact" style="display: none;">
                            <h4>Κρατήσεις ΕΟΠΥΥ</h4>
                            <div class="form-row form-row-tight">
                                <div class="form-group form-group-compact">
                                    <label>Παρακράτηση €</label>
                                    <input type="number" id="quickParakratisi" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>Παρακράτηση %</label>
                                    <input type="number" id="quickParakratisiPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>ΜΔΕ €</label>
                                    <input type="number" id="quickMDE" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>ΜΔΕ %</label>
                                    <input type="number" id="quickMDEPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                            </div>
                            <div class="form-row form-row-tight">
                                <div class="form-group form-group-compact">
                                    <label>Rebate €</label>
                                    <input type="number" id="quickRebate" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>Rebate %</label>
                                    <input type="number" id="quickRebatePercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>Κρατήσεις €</label>
                                    <input type="number" id="quickKrathseisEopyy" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>Κρατήσεις %</label>
                                    <input type="number" id="quickKrathseisEopyyPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                            </div>
                            <div class="form-row form-row-tight">
                                <div class="form-group form-group-compact">
                                    <label>Clawback €</label>
                                    <input type="number" id="quickClawback" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>Clawback %</label>
                                    <input type="number" id="quickClawbackPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>Περιοδικότητα Clawback</label>
                                    <select id="quickClawbackPeriod" class="form-select form-select-compact">
                                        <option value="monthly">Μηνιαίο</option>
                                        <option value="quarterly">Τριμηνιαίο</option>
                                        <option value="semiannual">Εξαμηνιαίο</option>
                                        <option value="annual">Ετήσιο</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Non-ΕΟΠΥΥ Deductions -->
                        <div id="quickNonEopyyDeductions" class="retention-fields retention-compact" style="display: none;">
                            <h4>Κρατήσεις</h4>
                            <div class="form-row form-row-tight">
                                <div class="form-group form-group-compact">
                                    <label>Κρατήσεις €</label>
                                    <input type="number" id="quickKrathseisOther" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                                <div class="form-group form-group-compact">
                                    <label>Κρατήσεις %</label>
                                    <input type="number" id="quickKrathseisOtherPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Final Amount Display -->
                        <div class="final-amount-display">
                            <strong>Τελικό Ποσό: <span id="quickFinalAmount">€ 0,00</span></strong>
                        </div>

                        <div class="form-group form-group-compact">
                            <label class="checkbox-label">
                                <input type="checkbox" id="quickNotesToggle">
                                <span>Προσθήκη Σημειώσεων</span>
                            </label>
                            <textarea id="quickNotes" class="form-textarea form-textarea-compact" rows="2" style="display: none;"></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-primary btn-compact">Καταχώριση</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dashboard Header (MOVED AFTER Quick Add) -->
            <div class="dashboard-header draggable-block" data-block="header">
                <div class="block-drag-handle">⋮⋮</div>
                <h3>Επισκόπηση</h3>
                <div class="quick-filters">
                    <select id="dashPeriod" class="form-select form-compact">
                        <option value="all" selected>Όλα</option>
                        <option value="month">Μήνας</option>
                        <option value="year">Έτος</option>
                    </select>
                    <label class="checkbox-label">
                        <input type="checkbox" id="dashIncludeParakratisi">
                        <span>Με Παρακράτηση</span>
                    </label>
                </div>
            </div>

            <!-- KPI Cards (Draggable Block #2) - REDESIGNED -->
            <div class="draggable-block" data-block="kpis">
                <div class="block-drag-handle">⋮⋮</div>
                <div class="kpi-grid kpi-grid-compact">
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="total">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">Συνολικά</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiTotal">€ 0,00</div>
                            <div class="kpi-percent" id="kpiTotalPercent">100%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="eopyy">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">ΕΟΠΥΥ</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiEopyy">€ 0,00</div>
                            <div class="kpi-percent" id="kpiEopyyPercent">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="others">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">Άλλα</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiOthers">€ 0,00</div>
                            <div class="kpi-percent" id="kpiOthersPercent">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="deductions">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">Κρατήσεις</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiDeductions">€ 0,00</div>
                            <div class="kpi-percent" id="kpiDeductionsPercent">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="parakratisi">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">Παρακράτηση</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiParakratisi">€ 0,00</div>
                            <div class="kpi-percent" id="kpiParakratisiPercent">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="mde">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">ΜΔΕ</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiMDE">€ 0,00</div>
                            <div class="kpi-percent" id="kpiMDEPercent">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="rebate">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">Rebate</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiRebate">€ 0,00</div>
                            <div class="kpi-percent" id="kpiRebatePercent">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="krathseis">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">Κρατήσεις</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiKrathseis">€ 0,00</div>
                            <div class="kpi-percent" id="kpiKrathseisPercent">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-card-redesign draggable-kpi" data-kpi="clawback">
                        <div class="kpi-handle">⋮</div>
                        <div class="kpi-label">Clawback</div>
                        <div class="kpi-content-row">
                            <div class="kpi-value kpi-value-compact" id="kpiClawback">€ 0,00</div>
                            <div class="kpi-percent" id="kpiClawbackPercent">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts (Draggable Block #3) -->
            <div class="draggable-block" data-block="charts">
                <div class="block-drag-handle">⋮⋮</div>
                <div class="charts-grid charts-grid-compact">
                    <div class="card card-compact">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>Έσοδα ανά Τύπο</h3>
                            <button type="button" class="btn-secondary btn-compact btn-sm" onclick="window.exportChartPDF('typeChart')">📄 PDF</button>
                        </div>
                        <div class="chart-filters">
                            <select id="typeChartSource" class="form-select form-compact">
                                <option value="">Όλα τα Διαγνωστικά</option>
                            </select>
                            <select id="typeChartPeriod" class="form-select form-compact">
                                <option value="all">Όλες οι Περίοδοι</option>
                            </select>
                            <label class="checkbox-label">
                                <input type="checkbox" id="typeChartParakratisi">
                                <span>Με Παρακράτηση</span>
                            </label>
                        </div>
                        <canvas id="typeChart"></canvas>
                    </div>
                    <div class="card card-compact">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>Μηνιαία Εξέλιξη</h3>
                            <button type="button" class="btn-secondary btn-compact btn-sm" onclick="window.exportChartPDF('monthlyChart')">📄 PDF</button>
                        </div>
                        <div class="chart-filters">
                            <select id="monthlyChartSource" class="form-select form-compact">
                                <option value="">Όλα τα Διαγνωστικά</option>
                            </select>
                            <label class="checkbox-label">
                                <input type="checkbox" id="monthlyShowTrend" checked>
                                <span>Trend Line</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="monthlyToggleData">
                                <span>Cash vs Invoice</span>
                            </label>
                        </div>
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Entries (Draggable Block #4) -->
            <div class="draggable-block" data-block="recent">
                <div class="block-drag-handle">⋮⋮</div>
                <div class="card card-compact">
                    <div class="collapsible-header" onclick="document.getElementById('recentEntriesContent').classList.toggle('collapsed')">
                        <h3>Πρόσφατες Εγγραφές</h3>
                        <button type="button" class="btn-secondary btn-compact btn-sm" id="exportDashboardPdfBtn">📄 PDF</button>
                        <span class="collapse-icon">▼</span>
                    </div>
                    <div id="recentEntriesContent" class="collapsible-content collapsed">
                        <div class="table-responsive">
                            <table class="data-table data-table-compact">
                                <thead>
                                    <tr>
                                        <th>Ημ/νία</th>
                                        <th>Διαγνωστικό</th>
                                        <th>Ασφάλεια</th>
                                        <th>Τύπος</th>
                                        <th class="text-right">Τελικό Ποσό</th>
                                    </tr>
                                </thead>
                                <tbody id="recentEntriesBody">
                                    <tr><td colspan="5" class="text-center">Δεν υπάρχουν εγγραφές</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Entries View -->
        <div id="entriesView" class="view">
            <div class="view-header">
                <h2>Εγγραφές</h2>
                <div class="view-actions">
                    <button id="importCsvBtn" class="btn-secondary btn-compact">📥 Import CSV</button>
                    <button id="exportCsvBtn" class="btn-secondary btn-compact">📤 Export CSV</button>
                    <button id="exportEntriesPdfBtn" class="btn-secondary btn-compact">📄 PDF</button>
                    <button id="addEntryBtn" class="btn-primary btn-compact">+ Νέα</button>
                </div>
            </div>

            <div class="card card-compact filters-card">
                <div class="form-row form-row-tight">
                    <div class="form-group form-group-compact">
                        <label>Από (ΜΜ/ΕΕΕΕ)</label>
                        <input type="text" id="filterDateFrom" class="form-input form-input-compact" placeholder="01/25">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Έως (ΜΜ/ΕΕΕΕ)</label>
                        <input type="text" id="filterDateTo" class="form-input form-input-compact" placeholder="12/25">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Διαγνωστικό</label>
                        <select id="filterSource" class="form-select form-select-compact">
                            <option value="">Όλα</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Ασφάλεια</label>
                        <select id="filterInsurance" class="form-select form-select-compact">
                            <option value="">Όλες</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Τύπος</label>
                        <select id="filterType" class="form-select form-select-compact">
                            <option value="">Όλοι</option>
                            <option value="cash">Μετρητά</option>
                            <option value="invoice">Τιμολόγια</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Ποσό Από (€)</label>
                        <input type="number" id="filterAmountFrom" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Ποσό Έως (€)</label>
                        <input type="number" id="filterAmountTo" class="form-input form-input-compact" step="0.01" min="0" max="9999999" placeholder="9999999">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Κρατήσεις Από (%)</label>
                        <input type="number" id="filterDeductionPercentFrom" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Κρατήσεις Έως (%)</label>
                        <input type="number" id="filterDeductionPercentTo" class="form-input form-input-compact" step="0.01" min="0" placeholder="100">
                    </div>
                </div>
                <div class="form-actions">
                    <button id="applyFiltersBtn" class="btn-primary btn-compact">Εφαρμογή</button>
                    <button id="clearFiltersBtn" class="btn-secondary btn-compact">Καθαρισμός</button>
                </div>
            </div>

            <div class="card card-compact">
                <div class="pagination-controls">
                    <label>Εγγραφές ανά σελίδα:</label>
                    <select id="pageSizeSelect" class="form-select form-compact">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="75">75</option>
                        <option value="100">100</option>
                        <option value="150">150</option>
                    </select>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table data-table-compact">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="date">Ημ/νία <span class="sort-icon"></span></th>
                                <th class="sortable" data-sort="source">Διαγνωστικό <span class="sort-icon"></span></th>
                                <th class="sortable" data-sort="insurance">Ασφάλεια <span class="sort-icon"></span></th>
                                <th class="sortable" data-sort="type">Τύπος <span class="sort-icon"></span></th>
                                <th class="sortable text-right" data-sort="amount">Αρχικό <span class="sort-icon"></span></th>
                                <th class="text-right">Παρακράτηση</th>
                                <th class="text-right">ΜΔΕ</th>
                                <th class="text-right">Rebate</th>
                                <th class="text-right">Κρατήσεις</th>
                                <th class="text-right">Clawback</th>
                                <th class="sortable text-right" data-sort="finalAmount">Τελικό <span class="sort-icon"></span></th>
                                <th>Σημειώσεις</th>
                                <th>Ενέργειες</th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody">
                            <tr><td colspan="13" class="text-center">Δεν υπάρχουν εγγραφές</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <!-- Reports View (NEW IMPLEMENTATION) -->
        <div id="reportsView" class="view">
            <h2>Αναφορές</h2>
            <div class="card card-compact">
                <h3>Δημιουργία Αναφοράς</h3>
                <div class="form-row">
                    <div class="form-group form-group-compact">
                        <label>Τύπος Αναφοράς</label>
                        <select id="reportType" class="form-select">
                            <option value="monthly">Μηνιαία</option>
                            <option value="quarterly">Τριμηνιαία</option>
                            <option value="annual">Ετήσια</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Περίοδος Από</label>
                        <input type="text" id="reportDateFrom" class="form-input" placeholder="01/2025">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Περίοδος Έως</label>
                        <input type="text" id="reportDateTo" class="form-input" placeholder="12/2025">
                    </div>
                </div>
                <button id="generateReportBtn" class="btn-primary">Δημιουργία Αναφοράς</button>
            </div>
            <div id="reportOutput" class="card card-compact" style="display: none;">
                <h3>Αποτελέσματα</h3>
                <div id="reportContent"></div>
            </div>
        </div>

        <!-- Comparison View (NEW IMPLEMENTATION) -->
        <div id="comparisonView" class="view">
            <h2>Σύγκριση Περιόδων</h2>
            <div class="comparison-selector">
                <div class="period-section card card-compact">
                    <h4>Περίοδος 1</h4>
                    <div class="form-group">
                        <label>Από (ΜΜ/ΕΕΕΕ)</label>
                        <input type="text" id="period1From" class="form-input" placeholder="01/2024">
                    </div>
                    <div class="form-group">
                        <label>Έως (ΜΜ/ΕΕΕΕ)</label>
                        <input type="text" id="period1To" class="form-input" placeholder="12/2024">
                    </div>
                </div>
                <div class="period-section card card-compact">
                    <h4>Περίοδος 2</h4>
                    <div class="form-group">
                        <label>Από (ΜΜ/ΕΕΕΕ)</label>
                        <input type="text" id="period2From" class="form-input" placeholder="01/2025">
                    </div>
                    <div class="form-group">
                        <label>Έως (ΜΜ/ΕΕΕΕ)</label>
                        <input type="text" id="period2To" class="form-input" placeholder="12/2025">
                    </div>
                </div>
            </div>
            <button id="comparePeriodsBtn" class="btn-primary">Σύγκριση</button>
            
            <div id="comparisonResults" style="display: none;">
                <div class="card card-compact">
                    <h3>Σύγκριση KPIs</h3>
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="card card-compact">
                    <h3>Πίνακας Σύγκρισης</h3>
                    <div class="table-responsive">
                        <table class="data-table comparison-table" id="comparisonTable">
                            <thead>
                                <tr>
                                    <th>Μετρική</th>
                                    <th>Περίοδος 1</th>
                                    <th>Περίοδος 2</th>
                                    <th>Αλλαγή</th>
                                    <th>Ποσοστό</th>
                                    <th>Τάση</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card card-compact">
                    <h3>Σύνοψη</h3>
                    <div id="comparisonSummary" class="comparison-summary"></div>
                </div>
            </div>
        </div>

        <!-- Forecasting View (NEW IMPLEMENTATION) -->
        <div id="forecastingView" class="view">
            <h2>Προβλέψεις</h2>
            <div class="card card-compact">
                <h3>Ρυθμίσεις Πρόβλεψης</h3>
                <div class="form-row">
                    <div class="form-group form-group-compact">
                        <label>Μέθοδος</label>
                        <select id="forecastMethod" class="form-select">
                            <option value="linear">Linear Regression</option>
                            <option value="seasonal">Seasonal Naive</option>
                            <option value="holt-winters">Holt-Winters</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Περίοδοι Πρόβλεψης</label>
                        <input type="number" id="forecastPeriods" class="form-input" value="6" min="1" max="24">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Ιστορικά Δεδομένα Από</label>
                        <input type="text" id="forecastHistoryFrom" class="form-input" placeholder="01/2024">
                    </div>
                </div>
                <button id="generateForecastBtn" class="btn-primary">Δημιουργία Πρόβλεψης</button>
            </div>
            
            <div id="forecastResults" style="display: none;">
                <div class="card card-compact">
                    <h3>Γράφημα Πρόβλεψης</h3>
                    <canvas id="forecastChart"></canvas>
                </div>
                <div class="card card-compact">
                    <h3>Σύνοψη</h3>
                    <div id="forecastSummary" class="forecast-summary"></div>
                </div>
                <div class="card card-compact methodology">
                    <h3>Μεθοδολογία</h3>
                    <div id="methodologyText"></div>
                </div>
            </div>
        </div>

        <!-- Heatmaps View (NEW IMPLEMENTATION) -->
        <div id="heatmapsView" class="view">
            <h2>Heatmaps</h2>
            <div class="card card-compact">
                <h3>Επιλογές Heatmap</h3>
                <div class="form-row">
                    <div class="form-group form-group-compact">
                        <label>Τύπος Heatmap</label>
                        <select id="heatmapType" class="form-select">
                            <option value="month-year">Μήνας × Έτος</option>
                            <option value="source-month">Διαγνωστικό × Μήνας</option>
                            <option value="insurance-month">Ασφάλεια × Μήνας</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Έτος (για Source/Insurance)</label>
                        <input type="number" id="heatmapYear" class="form-input" value="2025" min="2020" max="2030">
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Χρωματική Παλέτα</label>
                        <select id="heatmapColorScheme" class="form-select">
                            <option value="blue-red">Μπλε-Κόκκινο</option>
                            <option value="green-red">Πράσινο-Κόκκινο</option>
                            <option value="grayscale">Grayscale</option>
                        </select>
                    </div>
                </div>
                <button id="generateHeatmapBtn" class="btn-primary">Δημιουργία Heatmap</button>
                <button id="exportHeatmapPdfBtn" class="btn-secondary" style="display: none;">📄 Export PDF</button>
            </div>
            
            <div class="card card-compact">
                <div class="heatmap-canvas-container">
                    <canvas id="heatmapCanvas" width="1200" height="600"></canvas>
                </div>
            </div>
        </div>

        <!-- Cloud View (NEW IMPLEMENTATION) -->
        <div id="cloudView" class="view">
            <h2>Cloud Sync</h2>
            
            <div class="cloud-providers">
                <!-- Google Drive -->
                <div class="cloud-card card card-compact">
                    <div class="cloud-header">
                        <h3>Google Drive</h3>
                        <span class="cloud-status" id="googleDriveStatus">Αποσυνδεδεμένο</span>
                    </div>
                    <p>Αποθηκεύστε αυτόματα backups στο Google Drive.</p>
                    <div class="form-actions">
                        <button id="googleDriveConnect" class="btn-primary btn-compact">Σύνδεση</button>
                        <button id="googleDriveDisconnect" class="btn-secondary btn-compact" style="display: none;">Αποσύνδεση</button>
                        <button id="googleDriveUpload" class="btn-secondary btn-compact" style="display: none;">📤 Upload</button>
                    </div>
                    <div id="googleDriveFiles" class="cloud-files" style="display: none;">
                        <h4>Αρχεία:</h4>
                        <div id="googleDriveFilesList"></div>
                    </div>
                </div>

                <!-- Dropbox -->
                <div class="cloud-card card card-compact">
                    <div class="cloud-header">
                        <h3>Dropbox</h3>
                        <span class="cloud-status" id="dropboxStatus">Αποσυνδεδεμένο</span>
                    </div>
                    <p>Συγχρονισμός με Dropbox.</p>
                    <div class="form-actions">
                        <button id="dropboxConnect" class="btn-primary btn-compact">Σύνδεση</button>
                        <button id="dropboxDisconnect" class="btn-secondary btn-compact" style="display: none;">Αποσύνδεση</button>
                        <button id="dropboxUpload" class="btn-secondary btn-compact" style="display: none;">📤 Upload</button>
                    </div>
                    <div id="dropboxFiles" class="cloud-files" style="display: none;">
                        <h4>Αρχεία:</h4>
                        <div id="dropboxFilesList"></div>
                    </div>
                </div>

                <!-- OneDrive -->
                <div class="cloud-card card card-compact">
                    <div class="cloud-header">
                        <h3>OneDrive</h3>
                        <span class="cloud-status" id="onedriveStatus">Αποσυνδεδεμένο</span>
                    </div>
                    <p>Συγχρονισμός με Microsoft OneDrive.</p>
                    <div class="form-actions">
                        <button id="onedriveConnect" class="btn-primary btn-compact">Σύνδεση</button>
                        <button id="onedriveDisconnect" class="btn-secondary btn-compact" style="display: none;">Αποσύνδεση</button>
                        <button id="onedriveUpload" class="btn-secondary btn-compact" style="display: none;">📤 Upload</button>
                    </div>
                    <div id="onedriveFiles" class="cloud-files" style="display: none;">
                        <h4>Αρχεία:</h4>
                        <div id="onedriveFilesList"></div>
                    </div>
                </div>
            </div>

            <div class="card card-compact">
                <h3>Οδηγίες Ρύθμισης</h3>
                <div class="setup-instructions">
                    <p>Για να χρησιμοποιήσετε το Cloud Sync, χρειάζεται να ρυθμίσετε API credentials:</p>
                    <ol>
                        <li>Ανοίξτε το <code>cloudAdapters.js</code></li>
                        <li>Προσθέστε τα <code>clientId</code> για κάθε provider</li>
                        <li>Ρυθμίστε το <code>redirectUri</code> στο domain σας</li>
                    </ol>
                    <p>Για περισσότερες πληροφορίες, δείτε το <a href="https://docs.google.com/document/d/cloud-setup" target="_blank">Cloud Setup Guide</a>.</p>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="view">
            <h2>Ρυθμίσεις</h2>
            
            <div class="card card-compact">
                <h3>Εμφάνιση</h3>
                <div class="form-group form-group-compact">
                    <label class="checkbox-label">
                        <input type="checkbox" id="darkModeToggle">
                        <span>Σκοτεινό Θέμα</span>
                    </label>
                </div>
            </div>

            <div class="card card-compact">
                <h3>Backup</h3>
                <div class="form-actions">
                    <button id="exportBackupBtn" class="btn-primary btn-compact">💾 Export</button>
                    <button id="importBackupBtn" class="btn-secondary btn-compact">📤 Import</button>
                    <input type="file" id="backupFileInput" accept=".json" style="display: none;">
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                </div>
                
                <div class="autosave-settings">
                    <label class="checkbox-label">
                        <input type="checkbox" id="autosaveEnabled">
                        <span>Αυτόματη Αποθήκευση</span>
                    </label>
                    <div class="form-group form-group-compact" style="margin-top: 0.5rem;">
                        <label>Αριθμός Αλλαγών για Autosave:</label>
                        <input type="number" id="autosaveThreshold" class="form-input form-input-compact" min="1" max="50" value="5" step="1">
                        <small class="help-text">Ορίστε πόσες αλλαγές απαιτούνται πριν γίνει αυτόματο backup (1-50)</small>
                    </div>
                    <div id="autosaveStatus" class="autosave-status"></div>
                </div>
            </div>

            <div class="card card-compact">
                <h3>Διαγνωστικά (Πηγές)</h3>
                <div class="sortable-list" id="sourcesList"></div>
                <div class="form-row form-row-tight">
                    <input type="text" id="newSourceInput" class="form-input form-input-compact" placeholder="Νέο διαγνωστικό">
                    <button id="addNewSourceBtn" class="btn-add btn-compact">Προσθήκη</button>
                </div>
            </div>

            <div class="card card-compact">
                <h3>Ασφάλειες</h3>
                <div class="sortable-list" id="insurancesList"></div>
                <div class="form-row form-row-tight">
                    <input type="text" id="newInsuranceInput" class="form-input form-input-compact" placeholder="Νέα ασφάλεια">
                    <button id="addNewInsuranceBtn" class="btn-add btn-compact">Προσθήκη</button>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card card-compact danger-zone">
                <h3 style="color: var(--danger-color);">⚠️ Επικίνδυνη Ζώνη</h3>
                <div style="background-color: #fef2f2; border: 2px solid #ef4444; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                    <p style="color: #991b1b; margin-bottom: 0.25rem; font-size: 0.9rem;"><strong>ΠΡΟΣΟΧΗ:</strong> Διαγραφή όλων των δεδομένων!</p>
                    <small style="color: #b91c1c; font-size: 0.85rem;">Δημιουργήστε backup πριν προχωρήσετε.</small>
                </div>
                <button id="clearCacheBtn" class="btn-danger btn-compact">🗑️ Καθαρισμός Όλων</button>
                <div id="clearCacheReport" class="cache-report"></div>
            </div>
        </div>
    </main>

    <!-- Entry Modal (Draggable & Resizable) -->
    <div id="entryModal" class="modal">
        <div class="modal-content modal-compact modal-draggable modal-resizable">
            <div class="modal-header modal-drag-handle">
                <h3 id="modalTitle">Νέα Εγγραφή</h3>
                <button class="modal-close" onclick="document.getElementById('entryModal').classList.remove('active')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="entryId">
                <div class="form-row form-row-tight">
                    <div class="form-group form-group-compact">
                        <label>Ημερομηνία*</label>
                        <input type="text" id="entryDate" class="form-input form-input-compact" required>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Διαγνωστικό*</label>
                        <select id="entrySource" class="form-select form-select-compact" required>
                            <option value="">Επιλογή...</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Ασφάλεια*</label>
                        <select id="entryInsurance" class="form-select form-select-compact" required>
                            <option value="">Επιλογή...</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Τύπος*</label>
                        <select id="entryType" class="form-select form-select-compact" required>
                            <option value="cash">Μετρητά</option>
                            <option value="invoice">Τιμολόγια</option>
                        </select>
                    </div>
                    <div class="form-group form-group-compact">
                        <label>Ποσό (€)*</label>
                        <input type="number" id="entryAmount" class="form-input form-input-compact" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div id="modalEopyyDeductions" class="retention-fields retention-compact" style="display: none;">
                    <h4>Κρατήσεις ΕΟΠΥΥ</h4>
                    <div class="form-row form-row-tight">
                        <div class="form-group form-group-compact">
                            <label>Παρακράτηση €</label>
                            <input type="number" id="entryParakratisi" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>Παρακράτηση %</label>
                            <input type="number" id="entryParakratisiPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>ΜΔΕ €</label>
                            <input type="number" id="entryMDE" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>ΜΔΕ %</label>
                            <input type="number" id="entryMDEPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                    </div>
                    <div class="form-row form-row-tight">
                        <div class="form-group form-group-compact">
                            <label>Rebate €</label>
                            <input type="number" id="entryRebate" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>Rebate %</label>
                            <input type="number" id="entryRebatePercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>Κρατήσεις €</label>
                            <input type="number" id="entryKrathseisEopyy" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>Κρατήσεις %</label>
                            <input type="number" id="entryKrathseisEopyyPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                    </div>
                    <div class="form-row form-row-tight">
                        <div class="form-group form-group-compact">
                            <label>Clawback €</label>
                            <input type="number" id="entryClawback" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>Clawback %</label>
                            <input type="number" id="entryClawbackPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>Περιοδικότητα Clawback</label>
                            <select id="entryClawbackPeriod" class="form-select form-select-compact">
                                <option value="monthly">Μηνιαίο</option>
                                <option value="quarterly">Τριμηνιαίο</option>
                                <option value="semiannual">Εξαμηνιαίο</option>
                                <option value="annual">Ετήσιο</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="modalNonEopyyDeductions" class="retention-fields retention-compact" style="display: none;">
                    <h4>Κρατήσεις</h4>
                    <div class="form-row form-row-tight">
                        <div class="form-group form-group-compact">
                            <label>Κρατήσεις €</label>
                            <input type="number" id="entryKrathseisOther" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group form-group-compact">
                            <label>Κρατήσεις %</label>
                            <input type="number" id="entryKrathseisOtherPercent" class="form-input form-input-compact" step="0.01" min="0" placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="final-amount-display">
                    <strong>Τελικό Ποσό: <span id="modalFinalAmount">€ 0,00</span></strong>
                </div>

                <div class="form-group form-group-compact">
                    <label class="checkbox-label">
                        <input type="checkbox" id="entryNotesToggle">
                        <span>Προσθήκη Σημειώσεων</span>
                    </label>
                    <textarea id="entryNotes" class="form-textarea form-textarea-compact" rows="2" style="display: none;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary btn-compact" onclick="document.getElementById('entryModal').classList.remove('active')">Άκυρο</button>
                <button class="btn-primary btn-compact" onclick="window.saveEntry()">Αποθήκευση</button>
            </div>
            <div class="resize-handle"></div>
        </div>
    </div>

    <!-- Import Backup Modal (Draggable & Resizable) -->
    <div id="importBackupModal" class="modal">
        <div class="modal-content modal-large modal-compact modal-draggable modal-resizable">
            <div class="modal-header modal-drag-handle">
                <h3>Import Backup</h3>
                <button class="modal-close" onclick="document.getElementById('importBackupModal').classList.remove('active')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="import-mode-selection">
                    <h4>Επιλέξτε Μέθοδο</h4>
                    <div class="radio-group">
                        <label class="radio-label radio-label-compact">
                            <input type="radio" name="importMode" value="merge" checked>
                            <div class="radio-content">
                                <strong>Merge</strong>
                                <small>Προσθήκη νέων, ενημέρωση υπαρχόντων</small>
                            </div>
                        </label>
                        <label class="radio-label radio-label-compact">
                            <input type="radio" name="importMode" value="overwrite">
                            <div class="radio-content">
                                <strong>Overwrite</strong>
                                <small>Διαγραφή όλων και εισαγωγή από backup</small>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="importPreview" style="display: none;">
                    <h4>Preview</h4>
                    <div class="import-preview-info">
                        <div class="preview-section" id="backupInfo"></div>
                        <div class="preview-section" id="impactInfo"></div>
                    </div>
                </div>

                <div id="importReport" style="display: none;">
                    <h4>Αποτελέσματα</h4>
                    <div class="import-report-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary btn-compact" onclick="document.getElementById('importBackupModal').classList.remove('active')">Κλείσιμο</button>
                <button id="confirmImportBtn" class="btn-primary btn-compact">Επιβεβαίωση</button>
            </div>
            <div class="resize-handle"></div>
        </div>
    </div>

    <div id="toast" class="toast toast-compact"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>

    <script type="module" src="./app.js"></script>
</body>
</html